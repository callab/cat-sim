---
title: "Simple similiarity in CHILDES"
author: "Dan Yurovsky & Claire Bergey"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: false
number_sections: false
theme: lumen
toc_float: false
code_folding: hide
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(tidytext)
library(childesr)
library(modelr)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)

theme_set(theme_classic(base_size = 14))
```


```{r co-occurrence}

bootstrap <- function(data, n, size, id = ".id") {
    bootstrap <- purrr::rerun(n, resample_bootstrap(data))
    df <- tibble::data_frame(strap = bootstrap) %>%
      mutate(id = 1:n())
}

tokens <-  c("boat", "lake", "river", "bee", "ant", "honey", 
             "cow", "zebra", "milk")
example_tokens <- get_tokens(token = tokens)

co_occurrs <- example_tokens %>%
  mutate(token = tolower(gloss)) %>%
  group_by(utterance_id, token) %>%
  summarise(n = n()) %>%
  spread(token, n, fill = 0)  %>%
  ungroup() 

counts <- function(word, rows) {
  
  word <- enquo(word)

   samples <- co_occurrs %>%
    bootstrap(10, rows) %>%
    mutate(strap = purrr::map(strap, dplyr::as_data_frame)) %>%
    unnest()
  
  samples %>%
    filter((!!word) > 0) %>%
     select(-utterance_id) %>%
     group_by(id) %>%
     summarise_all(sum) %>%
     select(-id) %>%
     summarise_all(mean) %>%
     mutate(target = as.character(word)[2])
}


sections <- seq(1000, 30000, 1000)

co_occur_subset <- function(rows) {
  map(tokens, function(token) counts(!!as.symbol(token), rows)) %>%
    bind_rows() %>%
    mutate(rows = rows)
}


cumulative_co_occurs <- map(sections,  co_occur_subset) %>%
  bind_rows() %>%
  gather(word, count, tokens) %>%
  group_by(rows, target) %>%
  filter(target != word) %>%
  mutate(co_occur = count/sum(count, na.rm = T),
         co_occur = if_else(is.na(co_occur), 0, co_occur))


ggplot(cumulative_co_occurs, aes(x = rows, y= co_occur, color = word)) + 
  facet_wrap(~target) + 
  geom_line() +
  scale_color_brewer(palette = "Set1")

wide_co_occurs <- cumulative_co_occurs %>%
  select(-co_occur) %>%
  spread(word, count) %>%
  filter(max_row = 4500)


 # scale_y_continuous(limits = c(0, .3))




```
